<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts & Updates - Hope Foundation</title>
    <link rel="stylesheet" href="../css/style.css?v=2.0">
    <link rel="stylesheet" href="../css/admin.css?v=2.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="admin-body">
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-hands-helping"></i>
                    <span>Hope Foundation</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="home-editor.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Home Page Editor</span>
                </a>
                <a href="causes-manager.html" class="nav-item">
                    <i class="fas fa-hand-holding-heart"></i>
                    <span>Causes Manager</span>
                </a>
                <a href="gallery-manage.html" class="nav-item">
                    <i class="fas fa-images"></i>
                    <span>Gallery Management</span>
                </a>
                <a href="posts-manager.html" class="nav-item active">
                    <i class="fas fa-bullhorn"></i>
                    <span>Posts & Updates</span>
                </a>
                <a href="donations-view.html" class="nav-item">
                    <i class="fas fa-heart"></i>
                    <span>Donations</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="../index.html" class="nav-item" target="_blank">
                    <i class="fas fa-globe"></i>
                    <span>View Website</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1>Posts & Updates</h1>
                <p>Share announcements and updates with your visitors</p>
            </header>

            <div class="admin-content">
                <!-- Add New Post -->
                <div class="editor-section">
                    <h2><i class="fas fa-plus-circle"></i> Create New Post</h2>
                    <form id="postForm" class="admin-form">
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="postTitle">Post Title *</label>
                                <input type="text" id="postTitle" required placeholder="Enter post title">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="postContent">Post Content *</label>
                                <textarea id="postContent" rows="6" required
                                    placeholder="Write your announcement or update here..."></textarea>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="postType">Post Type</label>
                                <select id="postType">
                                    <option value="announcement">Announcement</option>
                                    <option value="event">Event</option>
                                    <option value="success-story">Success Story</option>
                                    <option value="news">News</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="postImage">Image URL (Optional)</label>
                                <input type="text" id="postImage" placeholder="images/post-image.jpg">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">
                            <i class="fas fa-paper-plane"></i> Publish Post
                        </button>
                    </form>
                </div>

                <!-- Recent Posts -->
                <div class="editor-section">
                    <h2><i class="fas fa-list"></i> Recent Posts</h2>
                    <div id="postsList" class="posts-list"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/admin-cms.js"></script>
    <script src="../js/script.js"></script>
    <script>
        // Load posts
        async function loadPosts() {
            try {
                const posts = await getPosts();
                const postsList = document.getElementById('postsList');

                if (!posts || posts.length === 0) {
                    postsList.innerHTML = '<p class="empty-state">No posts yet. Create your first post above!</p>';
                    return;
                }

                postsList.innerHTML = posts.map(post => `
                    <div class="post-item">
                        <div class="post-header">
                            <div class="post-info">
                                <h3>${post.title}</h3>
                                <div class="post-meta">
                                    <span class="post-type ${post.type}">${post.type ? post.type.replace('-', ' ') : 'Update'}</span>
                                    <span class="post-date"><i class="fas fa-clock"></i> ${formatDate(post.created_at)}</span>
                                    <span class="post-author"><i class="fas fa-user"></i> ${post.author_name || 'Admin'}</span>
                                </div>
                            </div>
                            <button onclick="removePost(${post.id})" class="btn-icon btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="post-content">${post.content}</p>
                        ${post.image ? `<img src="${post.image}" alt="${post.title}" class="post-image">` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                showNotification('Error loading posts', 'error');
            }
        }

        // Form submission
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
            btn.disabled = true;

            try {
                const postData = {
                    title: document.getElementById('postTitle').value,
                    content: document.getElementById('postContent').value,
                    type: document.getElementById('postType').value,
                };

                const fileInput = document.getElementById('postImageFile');
                if (fileInput && fileInput.files.length > 0) {
                    const uploadRes = await api.uploadImage(fileInput.files[0]);
                    if (uploadRes.success) {
                        postData.image = uploadRes.data.url;
                    }
                } else {
                    postData.image = document.getElementById('postImage').value;
                }

                await addPost(postData);
                document.getElementById('postForm').reset();
                await loadPosts();
            } catch (err) {
                console.error(err);
                showNotification('Error publishing post', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Remove post
        async function removePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                await deletePost(postId);
                await loadPosts();
            }
        }

        // Load posts on page load
        window.addEventListener('DOMContentLoaded', loadPosts);
    </script>
</body>

</html>